(()=>{"use strict";const e={version:browser.runtime.getManifest().version,db_version:3};class t{static has(e){return Object.prototype.hasOwnProperty.call(this._cache,e)}static get(e){return void 0===this._cache[e]?(void 0===this.defaults[e]&&console.warn(`Unrecognized SyncedStorage key "${e}"`),this.defaults[e]):this._cache[e]}static set(e,t){return this._cache[e]=t,this._adapter.set({[e]:t})}static import(e){for(const[t,s]of Object.entries(e))this._cache[t]=s;return this._adapter.set(e)}static remove(e){return void 0!==this._cache[e]&&delete this._cache[e],this._adapter.remove(e)}static keys(e=""){return Object.keys(this._cache).filter((t=>t.startsWith(e)))}static entries(){return Object.entries(this._cache)}static async clear(e=!1){let t;e?this._cache={}:t=this.persistent.reduce(((e,t)=>(e[t]=this._cache[t],e)),{}),await this._adapter.clear(),e||await this.import(t)}static async init(){browser.storage.onChanged.addListener((e=>{for(const[t,{newValue:s}]of Object.entries(e))this._cache[t]=s}));const e=await this._adapter.get(null);return Object.assign(this._cache,e),this._cache}static then(e,t){return this.init().then(e,t)}static toJson(){return JSON.stringify(this._cache)}}t.QUOTA_BYTES_PER_ITEM=8192,t._adapter=browser.storage.sync||browser.storage.local,t._cache={},t.defaults=Object.freeze({language:"english",version:e.version,version_show:!0,highlight_owned_color:"#00ce67",highlight_wishlist_color:"#0491bf",highlight_coupon_color:"#a26426",highlight_inv_gift_color:"#800040",highlight_inv_guestpass_color:"#513c73",highlight_notinterested_color:"#4f4f4f",highlight_collection_color:"#856d0e",highlight_waitlist_color:"#4c7521",tag_owned_color:"#00b75b",tag_wishlist_color:"#0383b4",tag_coupon_color:"#c27120",tag_inv_gift_color:"#b10059",tag_inv_guestpass_color:"#65449a",tag_notinterested_color:"#4f4f4f",tag_collection_color:"#856d0e",tag_waitlist_color:"#4c7521",highlight_owned:!0,highlight_wishlist:!0,highlight_coupon:!1,highlight_inv_gift:!1,highlight_inv_guestpass:!1,highlight_notinterested:!1,highlight_excludef2p:!1,highlight_collection:!0,highlight_waitlist:!0,tag_owned:!1,tag_wishlist:!1,tag_coupon:!1,tag_inv_gift:!1,tag_inv_guestpass:!1,tag_notinterested:!0,tag_collection:!1,tag_waitlist:!1,tag_short:!1,hidetmsymbols:!1,showlowestprice:!0,showlowestprice_onwishlist:!0,showlowestpricecoupon:!0,showallstores:!0,stores:[],override_price:"auto",showregionalprice:"mouse",regional_countries:["us","gb","ru","br","au","jp"],show_es_homepagetabs:!0,showmarkettotal:!1,showsteamrepapi:!0,showmcus:!0,showoc:!0,showhltb:!0,showyoutube:!0,showtwitch:!0,showpcgw:!0,showcompletionistme:!1,showprotondb:!1,showviewinlibrary:!1,showsteamcardexchange:!1,showitadlinks:!0,showsteamdb:!0,showbartervg:!1,showastatslink:!0,showyoutubegameplay:!0,showyoutubereviews:!0,showwsgf:!0,exfgls:!0,app_custom_link:[{enabled:!1,name:"Google",url:"google.com/search?q=[ID]+[NAME]",icon:"www.google.com/images/branding/product/ico/googleg_lodp.ico"}],customize_apppage:{recentupdates:!0,reviews:!0,about:!0,contentwarning:!0,steamchart:!0,steamspy:!0,surveys:!0,sysreq:!0,legal:!0,morelikethis:!0,recommendedbycurators:!0,customerreviews:!0},customize_frontpage:{featuredrecommended:!0,specialoffers:!0,trendingamongfriends:!0,discoveryqueue:!0,browsesteam:!0,curators:!0,morecuratorrecommendations:!0,recentlyupdated:!0,fromdevelopersandpublishersthatyouknow:!0,popularvrgames:!0,homepagetabs:!0,gamesstreamingnow:!0,under:!0,updatesandoffers:!0,homepagesidebar:!0},show_package_info:!1,show_steamchart_info:!0,show_steamspy_info:!0,show_early_access:!0,show_alternative_linux_icon:!1,show_itad_button:!1,skip_got_steam:!1,installsteam:"show",openinnewtab:!1,keepssachecked:!1,showemptywishlist:!0,user_notes_app:!0,user_notes_wishlist:!0,showwishliststats:!0,user_notes:{},user_notes_adapter:"synced_storage",replaceaccountname:!0,showlanguagewarning:!0,showlanguagewarninglanguage:"english",homepage_tab_selection:"remember",homepage_tab_last:null,send_age_info:!0,removebroadcasts:!1,mp4video:!1,horizontalscrolling:!0,showsupportinfo:!0,showdrm:!0,regional_hideworld:!1,showinvnav:!0,quickinv:!0,quickinv_diff:-.01,community_default_tab:"",showallachievements:!1,showallstats:!0,showachinstore:!0,showcomparelinks:!1,hideactivelistings:!1,showlowestmarketprice:!0,hidespamcomments:!1,spamcommentregex:"[\\u2500-\\u25FF]",wlbuttoncommunityapp:!0,removeguideslanguagefilter:!1,disablelinkfilter:!1,sortfriendsby:"default_ASC",sortreviewsby:"default_ASC",sortgroupsby:"default_ASC",show1clickgoo:!0,show_profile_link_images:"gray",show_custom_themes:!0,profile_steamrepcn:!0,profile_steamgifts:!0,profile_steamtrades:!0,profile_bartervg:!0,profile_steamrep:!0,profile_steamdbcalc:!0,profile_astats:!0,profile_backpacktf:!0,profile_astatsnl:!0,profile_steamid:!0,profile_custom_link:[{enabled:!0,name:"Google",url:"google.com/search?q=[ID]",icon:"www.google.com/images/branding/product/ico/googleg_lodp.ico"}],fav_emoticons:[],group_steamgifts:!0,steamcardexchange:!0,purchase_dates:!0,show_badge_progress:!0,show_coupon:!0,show_wishlist_link:!0,show_wishlist_count:!0,show_progressbar:!0,show_backtotop:!1,profile_showcase_twitch:!0,profile_showcase_own_twitch:!1,profile_showcase_twitch_profileonly:!1,itad_import_library:!1,itad_import_wishlist:!1,add_to_waitlist:!1,context_steam_store:!1,context_steam_market:!1,context_itad:!1,context_bartervg:!1,context_steamdb:!1,context_steamdb_instant:!1,context_steam_keys:!1}),t.persistent=["user_notes","user_notes_adapter"],void 0===Promise.prototype.finally&&Object.defineProperty(Promise.prototype,"finally",{value:function(e){const t=this.constructor;return this.then((s=>t.resolve(e()).then((()=>s))),(s=>t.resolve(e()).then((()=>{throw console.error(s),s}))))}});let s=!1;class r extends Error{constructor(e){super(e),this.name="LoginError"}}class a extends Error{constructor(e){super(e),this.name="ServerOutageError"}}class n extends Error{constructor(e,t){super(t),this.code=e}}class o extends Error{constructor(e,t){super(e),this.featureName=t}}const i={LoginError:r,ServerOutageError:a,HTTPError:n,FeatureDependencyError:o};class c{static escape(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,(e=>t[e]))}static fragment(e){const t=document.createElement("template");return t.innerHTML=DOMPurify.sanitize(e),t.content}static element(e){return c.fragment(e).firstElementChild}static _getNode(e){let t=e;return null==t?(console.warn(t+" is not an Element."),null):("string"==typeof t&&(t=document.querySelector(t)),t instanceof Element?t:(console.warn(t+" is not an Element."),null))}static inner(e,t){const s=c._getNode(e);return s&&(s.innerHTML=DOMPurify.sanitize(t)),s}static replace(e,t){const s=c._getNode(e);return s&&(s.outerHTML=DOMPurify.sanitize(t)),s}static wrap(e,t){const s=c._getNode(e);if(s){const e=c.element(t);return s.replaceWith(e),e.append(s),e}return s}static adjacent(e,t,s){const r=c._getNode(e);return r&&r.insertAdjacentHTML(t,DOMPurify.sanitize(s)),r}static beforeBegin(e,t){c.adjacent(e,"beforebegin",t)}static afterBegin(e,t){c.adjacent(e,"afterbegin",t)}static beforeEnd(e,t){c.adjacent(e,"beforeend",t)}static afterEnd(e,t){c.adjacent(e,"afterend",t)}}class l{static clearSpecialSymbols(e){return e.replace(/[\u00AE\u00A9\u2122]/g,"")}static htmlToDOM(e){return c.fragment(e)}static htmlToElement(e){return c.element(e)}static getVariableFromText(e,t,s){let r;if("object"===s)r=new RegExp(t+"\\s*=\\s*(\\{.+?\\});");else if("array"===s)r=new RegExp(t+"\\s*=\\s*(\\[.+?\\]);");else if("int"===s)r=new RegExp(t+"\\s*=\\s*(.+?);");else{if("string"!==s)return null;r=new RegExp(t+'\\s*=\\s*(\\".+?\\");')}const a=e.match(r);return a?"int"===s?parseInt(a[1]):JSON.parse(a[1]):null}static getVariableFromDom(e,t,s=document){for(const r of s.querySelectorAll("script")){const s=l.getVariableFromText(r.textContent,e,t);if(null!==s)return s}return null}}class u{static get(e,t){const s=e.trim();return u.cache.has(s)?u.cache.get(s):t}static set(e,t,s=31536e3){let r=e.trim(),a=t.trim();u.cache.set(r,a),r=encodeURIComponent(r),a=encodeURIComponent(a),document.cookie=`${r}=${a}; max-age=${s}`}static remove(e){let t=e.trim();u.cache.delete(t),t=encodeURIComponent(t),document.cookie=t+"; expires=Thu, 01 Jan 1970 00:00:00 GMT"}static init(){u.cache=new Map;for(let[e,t]of document.cookie.split(";").map((e=>e.split("="))))e=e.trim(),u.cache.set(e,decodeURIComponent(t))}}u.init();const p=Object.freeze({BACKGROUND:1,CONTENT_SCRIPT:2,OPTIONS:3});let d;if(browser.extension.getBackgroundPage){const e=browser.extension.getBackgroundPage();d=e===window?p.BACKGROUND:p.OPTIONS}else d=p.CONTENT_SCRIPT;class m{static getCurrentSteamLanguage(){if(null!==this._currentSteamLanguage)return this._currentSteamLanguage;for(const e of document.querySelectorAll("script[src]")){const t=new URL(e.src).searchParams.get("l");if(t)return m._currentSteamLanguage=t,this._currentSteamLanguage}return class{static isBackgroundScript(){return d===p.BACKGROUND}static isContentScript(){return d===p.CONTENT_SCRIPT}static isOptions(){return d===p.OPTIONS}}.isContentScript()&&(m._currentSteamLanguage=u.get("Steam_Language")||null),this._currentSteamLanguage}static getLanguageCode(e){return m.languages[e]||"en"}static isCurrentLanguageOneOf(e){return e.includes(m.getCurrentSteamLanguage())}}m._currentSteamLanguage=null,m.languages={english:"en",bulgarian:"bg",czech:"cs",danish:"da",dutch:"nl",finnish:"fi",french:"fr",greek:"el",german:"de",hungarian:"hu",italian:"it",japanese:"ja",koreana:"ko",norwegian:"no",polish:"pl",portuguese:"pt-PT",brazilian:"pt-BR",russian:"ru",romanian:"ro",schinese:"zh-CN",spanish:"es-ES",latam:"es-419",swedish:"sv-SE",tchinese:"zh-TW",thai:"th",turkish:"tr",ukrainian:"ua",vietnamese:"vi"};class h{static getURL(e){return browser.runtime.getURL(e)}static get(e){return fetch(h.getURL(e))}static getJSON(e){return h.get(e).then((e=>e.json()))}static getText(e){return h.get(e).then((e=>e.text()))}}class g{static loadLocalization(e){return h.getJSON(`/localization/${e}.json`)}static init(){if(g._promise)return g._promise;let e=m.getCurrentSteamLanguage();const s=t.get("language");function r(e,t){for(const[s,a]of Object.entries(t))void 0!==e[s]?"object"==typeof a?r(e[s],a):""!==a&&(e[s]=a):console.warn("The key %s doesn't exist in the English localization file",s);return e}null===e?e=s:e!==s&&(t.set("language",e),class{static message(e){return browser.runtime.sendMessage(e)}static action(e,...t){return t.length?this.message({action:e,params:t}):this.message({action:e})}}.action("clearpurchases"));const a=m.getLanguageCode(e),n=["en"];return null!==a&&"en"!==a&&n.push(a),g._promise=Promise.all(n.map((e=>g.loadLocalization(e)))).then((([e,t])=>(g.str=e,t&&r(g.str,t),g.str))),g._promise}static then(e,t){return g.init().then(e,t)}static getString(e){const t=e.split(".").reverse();let s=g.str;for(;t.length;){if("object"!=typeof s)return null;s=s[t.pop()]}return s}}g._promise=null;const w=Object.freeze({context_steam_store:{persistent:!0,permissions:["contextMenus"]},context_steam_market:{persistent:!0,permissions:["contextMenus"]},context_itad:{persistent:!0,permissions:["contextMenus"]},context_bartervg:{persistent:!0,permissions:["contextMenus"]},context_steamdb:{persistent:!0,permissions:["contextMenus"]},context_steamdb_instant:{persistent:!0,permissions:["contextMenus"]},context_steam_keys:{persistent:!0,permissions:["contextMenus"]}});class f{static contains(e){return browser.permissions.contains({permissions:e})}static async request(e){return!!await this.contains(e)||browser.permissions.request({permissions:e})}static remove(e){return e.includes("contextMenus")&&browser.contextMenus.removeAll(),browser.permissions.remove({permissions:e})}static async when(e,t,s){t&&(await f.contains([e])&&t(),browser.permissions.onAdded.addListener((s=>{s.permissions.includes(e)&&t()}))),s&&browser.permissions.onRemoved.addListener((t=>{t.permissions.includes(e)&&s()}))}static requestOption(e){return f.request(w[e].permissions)}static removeOption(e){const t=f._getUnusedPermissions(e);return 0===t.length?Promise.resolve(!0):f.remove(t)}static _getUnusedPermissions(e){const s=new Set;for(const[r,a]of Object.entries(w))if(e!==r&&(!a.persistent||t.get(r)))for(const e of a.permissions)s.add(e);const r=new Set;for(const t of w[e].permissions)s.has(t)||r.add(t);return Array.from(r.values())}}class y{static onClick(e){const t=encodeURIComponent(e.selectionText.trim()),s=y.queryLinks[e.menuItemId];if(s)if("context_steam_keys"===e.menuItemId){const e=t.match(/[A-Z0-9]{5}(-[A-Z0-9]{5}){2}/g);if(!e||0===e.length)return void window.alert(g.str.options.no_keys_found);for(const t of e)browser.tabs.create({url:s.replace("__steamkey__",t)})}else browser.tabs.create({url:s.replace("__query__",t)})}static async build(){await g,await t;for(const e of Object.keys(y.queryLinks))t.get(e)&&browser.contextMenus.create({id:e,title:g.str.options[e].replace("__query__","%s"),contexts:["selection"]},(()=>chrome.runtime.lastError))}static async update(){return await f.contains(["contextMenus"])?(await browser.contextMenus.removeAll(),y.build()):null}}y.queryLinks={context_steam_store:"https://store.steampowered.com/search/?term=__query__",context_steam_market:"https://steamcommunity.com/market/search?q=__query__",context_itad:"https://isthereanydeal.com/search/?q=__query__",context_bartervg:"https://barter.vg/search?q=__query__",context_steamdb:"https://steamdb.info/search/?q=__query__",context_steamdb_instant:"https://steamdb.info/instantsearch/?query=__query__",context_steam_keys:"https://store.steampowered.com/account/registerkey?key=__steamkey__"};class _{constructor(e){this._promise=new Promise((t=>{this._id=setTimeout((()=>{t()}),e)}))}then(e,t){if(this._promise)return this._promise.then(e,t);throw new Error("Timer has been cleared before")}clear(){clearTimeout(this._id),this._promise=null}}class b{constructor(e,t){this.onDone=e,this.duration=t,this.reset()}get running(){return this._running}reset(){void 0!==this._id&&clearTimeout(this._id),this._id=setTimeout((async()=>{await this.onDone(),this._running=!1}),this.duration),this._running=!0}}class v{static timer(e){return new _(e)}static resettableTimer(e,t){return new b(e,t)}static now(){return Math.trunc(Date.now()/1e3)}}let S,k;const x=new WeakMap,A=new WeakMap,E=new WeakMap,I=new WeakMap,O=new WeakMap;let P={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return A.get(e);if("objectStoreNames"===t)return e.objectStoreNames||E.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return C(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function j(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(D(this),e),C(x.get(this))}:function(...e){return C(t.apply(D(this),e))}:function(e,...s){const r=t.call(D(this),e,...s);return E.set(r,e.sort?e.sort():[e]),C(r)}:(e instanceof IDBTransaction&&function(e){if(A.has(e))return;const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",n),e.removeEventListener("abort",n)},a=()=>{t(),r()},n=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",n),e.addEventListener("abort",n)}));A.set(e,t)}(e),s=e,(S||(S=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>s instanceof e))?new Proxy(e,P):e);var t,s}function C(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,s)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",n)},a=()=>{t(C(e.result)),r()},n=()=>{s(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",n)}));return t.then((t=>{t instanceof IDBCursor&&x.set(t,e)})).catch((()=>{})),O.set(t,e),t}(e);if(I.has(e))return I.get(e);const t=j(e);return t!==e&&(I.set(e,t),O.set(t,e)),t}const D=e=>O.get(e),T=["get","getKey","getAll","getAllKeys","count"],F=["put","add","delete","clear"],L=new Map;function M(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(L.get(t))return L.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,a=F.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!a&&!T.includes(s))return;const n=async function(e,...t){const n=this.transaction(e,a?"readwrite":"readonly");let o=n.store;r&&(o=o.index(t.shift()));const i=await o[s](...t);return a&&await n.done,i};return L.set(t,n),n}var R;R=P,P={...R,get:(e,t,s)=>M(e,t)||R.get(e,t,s),has:(e,t)=>!!M(e,t)||R.has(e,t)};class q{static init(){return q._promise||(q._promise=function(e,t,{blocked:s,upgrade:r,blocking:a,terminated:n}={}){const o=indexedDB.open(e,t),i=C(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(C(o.result),e.oldVersion,e.newVersion,C(o.transaction))})),s&&o.addEventListener("blocked",(()=>s())),i.then((e=>{n&&e.addEventListener("close",(()=>n())),a&&e.addEventListener("versionchange",(()=>a()))})).catch((()=>{})),i}("Augmented Steam",e.db_version,{upgrade(e,t,s,r){t<1&&(e.createObjectStore("coupons").createIndex("appid","appids",{unique:!1,multiEntry:!0}),e.createObjectStore("giftsAndPasses").createIndex("appid","",{unique:!1,multiEntry:!0}),e.createObjectStore("items"),e.createObjectStore("earlyAccessAppids"),e.createObjectStore("purchases"),e.createObjectStore("dynamicStore").createIndex("appid","",{unique:!1,multiEntry:!0}),e.createObjectStore("packages").createIndex("expiry","expiry"),e.createObjectStore("storePageData").createIndex("expiry","expiry"),e.createObjectStore("profiles").createIndex("expiry","expiry"),e.createObjectStore("rates"),e.createObjectStore("notes"),e.createObjectStore("collection"),e.createObjectStore("waitlist"),e.createObjectStore("itadImport")),t<2&&(e.createObjectStore("workshopFileSizes").createIndex("expiry","expiry"),e.createObjectStore("reviews").createIndex("expiry","expiry")),t<3&&(e.createObjectStore("expiries").createIndex("expiry",""),r.objectStore("packages").deleteIndex("expiry"),r.objectStore("storePageData").deleteIndex("expiry"),r.objectStore("profiles").deleteIndex("expiry"),r.objectStore("workshopFileSizes").deleteIndex("expiry"),r.objectStore("reviews").deleteIndex("expiry"))},blocked(){console.error("Failed to upgrade database, there is already an open connection")}}).then((e=>{q.db=e})).then(q._deleteOldData)),q._promise}static then(e,t){return q.init().then(e,t)}static async _deleteOldData(){const e=q.db.transaction("expiries","readwrite").store;let t=await e.index("expiry").openCursor(IDBKeyRange.upperBound(v.now()));const s=[],r={},a=[];for(;t;)s.push(t.primaryKey),a.push(e.delete(t.primaryKey)),t=await t.continue();for(const e of s){const[t,s]=e.split(/_/);r[t]||(r[t]=[]),s&&r[t].push(s)}for(const[e,t]of Object.entries(r)){const s=q.db.transaction(e,"readwrite").store;q.timestampedStores.has(e)?a.push(s.clear()):a.push(Promise.all(t.map((e=>{const t=s.delete(e),r=Number(e);return r?Promise.all([t,s.delete(r)]):t}))))}return Promise.all(a)}static async put(e,t,{ttl:s,multiple:r="object"==typeof t}={}){const a=q.db.transaction(e,"readwrite");let n;const o=[],i=q.cacheObjectStores.has(e),c=q.timestampedEntriesStores.has(e);function l(t){let s;s=a.store.autoIncrement||null!==a.store.keyPath?a.store.put(t):a.store.put(null,t),s.then((t=>{c&&o.push(`${e}_${t}`)}))}if(i){const t=s||q.cacheObjectStores.get(e);n=v.now()+t,c||o.push(e)}if(r)if(Array.isArray(t))t.forEach(l);else if("object"==typeof t){const s=t instanceof Map?t.entries():Object.entries(t);for(const[t,r]of s)a.store.put(r,t).then((t=>{c&&o.push(`${e}_${t}`)}))}else console.warn("multiple parameter specified but the data is a primitive");else l(t);await a.done;const u=q.db.transaction("expiries","readwrite");for(const e of o)u.store.put(n,e);return u.done}static async get(e,t,s={}){const r=q._asArray(t);await Promise.all([q.checkStoreExpiry(e,s),q.checkEntryExpiry(e,r,s)]);const a=q.db.transaction(e).store,n=await Promise.all(r.map((e=>a.get(e))));return Array.isArray(t)?q._resultsAsObject(r,n):n[0]}static async getAll(e,t={}){const s=[],r=[];let a;for(await q.checkStoreExpiry(e,t),q.timestampedEntriesStores.has(e)&&await q.checkEntryExpiry(e,await q.db.getAllKeys(e),t),a=await q.db.transaction(e).store.openCursor();a;)s.push(a.key),r.push(a.value),a=await a.continue();return q._resultsAsObject(s,await Promise.all(r))}static async getFromIndex(e,t,s,r={}){if(q.timestampedEntriesStores.has(e))return null;await q.checkStoreExpiry(e,r);const a=q._asArray(s),n=q.db.transaction(e).store.index(t),o=await Promise.all(a.map((e=>r.asKey?r.all?n.getAllKeys(e):n.getKey(e):r.all?n.getAll(e):n.get(e))));return Array.isArray(s)?q._resultsAsObject(a,o):o[0]}static async indexContainsKey(e,t,s,r={}){if(q.timestampedEntriesStores.has(e))return null;await q.checkStoreExpiry(e,r);const a=q._asArray(s),n=q.db.transaction(e).store.index(t),o=await Promise.all(a.map((e=>n.openKeyCursor(e).then((e=>Boolean(e))))));return Array.isArray(s)?q._resultsAsObject(a,o):o[0]}static delete(e,t){const s=q._asArray(t),r=q.db.transaction(e,"readwrite").store;let a;return q.cacheObjectStores.has(e)&&(a=q.db.transaction("expiries","readwrite").store),Promise.all(s.map((t=>{const s=r.delete(t);return a?Promise.all([s,a.delete(q.timestampedStores.has(e)?e:`${e}_${t}`)]):s})))}static clear(e=Array.from(q.cacheObjectStores.keys())){const t=q._asArray(e);let s;return t.some((e=>q.cacheObjectStores.has(e)))&&(s=q.db.transaction("expiries","readwrite").store),Promise.all(t.map((e=>{const t=q.db.clear(e);if(q.cacheObjectStores.has(e)){let r;return r=q.timestampedStores.has(e)?e:IDBKeyRange.bound(e+"_",`${e}${String.fromCharCode("_".charCodeAt(0)+1)}`,!1,!0),Promise.all([t,s.delete(r)])}return t})))}static async contains(e,t,s={}){const r=q._asArray(t);await Promise.all([q.checkStoreExpiry(e,s),q.checkEntryExpiry(e,r,s)]);const a=q.db.transaction(e).store,n=await Promise.all(r.map((e=>a.openCursor(e).then((e=>Boolean(e))))));return Array.isArray(t)?q._resultsAsObject(r,n):n[0]}static async checkEntryExpiry(e,t,s={}){if(!q.timestampedEntriesStores.has(e))return null;const r=q.db.transaction("expiries"),a=[];for(const s of t)r.store.get(`${e}_${s}`).then((e=>{e&&!q.isExpired(e)||a.push(s)}));if(await r.done,s.preventFetch){const t=q.db.transaction(e,"readwrite");for(const e of a)t.store.delete(e);return t.done}return Promise.all(a.map((t=>q.fetchUpdatedData(e,t,s.params))))}static async checkStoreExpiry(e,t={}){if(!q.timestampedStores.has(e))return null;const s=await q.db.get("expiries",e);let r=!0;return s&&(r=q.isExpired(s)),r&&(await q.clear(e),!t.preventFetch)?q.fetchUpdatedData(e,null,t.params):null}static fetchUpdatedData(e,t,s){const r=t?`${e}_${t}`:e;if(q._ongoingRequests.has(r))return q._ongoingRequests.get(r);let a;const n=q.timestampedStores.has(e);return a=n?q.objStoreFetchFns.get(e)({params:s}):q.objStoreFetchFns.get(e)({params:s,key:t}),a=a.catch((async s=>{throw console.group("Object store data"),t?console.error("Failed to update key %s of object store %s",t,e):console.error("Failed to update object store %s",e),console.error(s),console.groupEnd(),await q.db.put("expiries",v.now()+60,n?e:`${e}_${t}`),s})).finally((()=>q._ongoingRequests.delete(r))),q._ongoingRequests.set(r,a),a}static isExpired(e){return e<=v.now()}static _asArray(e){return Array.isArray(e)?e:[e]}static _resultsAsObject(e,t){return e.reduce(((e,s,r)=>(e[s]=t[r],e)),{})}}q._promise=null,q._ongoingRequests=new Map,q.timestampedStores=new Map([["coupons",3600],["giftsAndPasses",3600],["items",3600],["earlyAccessAppids",3600],["purchases",86400],["dynamicStore",900],["rates",3600],["collection",900],["waitlist",900]]),q.timestampedEntriesStores=new Map([["packages",604800],["storePageData",3600],["profiles",86400],["workshopFileSizes",432e3],["reviews",3600]]),q.cacheObjectStores=new Map([...q.timestampedStores,...q.timestampedEntriesStores]);class N{static get(e,t){const s=localStorage.getItem(e);if(!s)return t;try{return JSON.parse(s)}catch(e){return t}}static set(e,t){localStorage.setItem(e,JSON.stringify(t))}static has(e){return null!==localStorage.getItem(e)}static remove(e){localStorage.removeItem(e)}static keys(){const e=[];for(let t=localStorage.length-1;t>=0;--t)e.push(localStorage.key(t));return e}static clear(){localStorage.clear()}}class W{static parseId(e){if(!e)return null;return parseInt(e)||null}static getAppid(e){let t=e;if(!t)return null;if(t instanceof HTMLElement){const e=t.dataset.dsAppid;if(e)return W.parseId(e);if(t=t.href,!t)return null}const s=t.match(/(?:store\.steampowered|steamcommunity)\.com\/(?:app|market\/listings)\/(\d+)\/?/);return s&&W.parseId(s[1])}static getSubid(e){let t=e;if(!t)return null;if(t instanceof HTMLElement){const e=t.dataset.dsPackageid;if(e)return W.parseId(e);if(t=t.href,!t)return null}const s=t.match(/(?:store\.steampowered|steamcommunity)\.com\/sub\/(\d+)\/?/);return s&&W.parseId(s[1])}static getBundleid(e){let t=e;if(!t)return null;if(t instanceof HTMLElement){const e=t.dataset.dsBundleid;if(e)return W.parseId(e);if(t=t.href,!t)return null}const s=t.match(/(?:store\.steampowered|steamcommunity)\.com\/bundle\/(\d+)\/?/);return s&&W.parseId(s[1])}static trimStoreId(e){return Number(e.slice(e.indexOf("/")+1))}static getAppidImgSrc(e){if(!e)return null;const t=e.match(/(?:cdn\.akamai\.steamstatic\.com\/steam|steamcdn-a\.akamaihd\.net\/steam|steamcommunity\/public\/images)\/apps\/(\d+)\//);return t&&W.parseId(t[1])}static getAppidUriQuery(e){if(!e)return null;const t=e.match(/appid=(\d+)/);return t&&W.parseId(t[1])}static getAppids(e){const t=/(?:store\.steampowered|steamcommunity)\.com\/app\/(\d+)\/?/g,s=[];let r;for(;null!==(r=t.exec(e));){const e=W.parseId(r[1]);e&&s.push(e)}return s}static getAppidFromId(e){if(!e)return null;const t=e.match(/game_(\d+)/);return t&&W.parseId(t[1])}static getAppidFromGameCard(e){if(!e)return null;const t=e.match(/\/gamecards\/(\d+)/);return t&&W.parseId(t[1])}}class z{static _fetchWithDefaults(e,t={},s={}){const r=new URL(e,this.origin),a={...this.params,...s};if(a&&"POST"===a.method&&!a.body){const e=new FormData;for(const[s,r]of Object.entries(t))e.append(s,r);a.body=e}else for(const[e,s]of Object.entries(t))r.searchParams.append(e,s);return fetch(r,a)}static async getEndpoint(e,t,s,r={}){let a=e;e.endsWith("/")||(a+="/");const n=await this._fetchWithDefaults(a,t,Object.assign(r,{method:"GET"}));return s&&s(n),n.json()}static async getPage(e,t,s,r={}){const a=await this._fetchWithDefaults(e,t,Object.assign(r,{method:"GET"}));return s&&s(a),a.text()}static async postEndpoint(e,t,s,r={}){let a=e;e.endsWith("/")||(a+="/");const n=await this._fetchWithDefaults(a,t,Object.assign(r,{method:"POST"}));return s&&s(n),n.json()}static async deleteEndpoint(e,t,s,r={}){let a=e;e.endsWith("/")||(a+="/");const n=await this._fetchWithDefaults(a,t,Object.assign(r,{method:"DELETE"}));return s&&s(n),n.json()}static endpointFactory(e,t){return async s=>{let r=await this.getEndpoint(e,s);if(t)if(Array.isArray(t))for(const e of t)r=r[e];else r=r[t];else r=r.data;return r}}static endpointFactoryCached(e,t,s){return async({params:r,key:a}={})=>{let n=await this.getEndpoint(e,r);return n=s?s(n.data):n.data,q.put(t,void 0===a?n:new Map([[a,n]]))}}}z.params={};class B{static isExpired(e,t){let s=t;return!e||(("number"!=typeof t||s<0)&&(s=0),e+s<=v.now())}static get(e,t,s){if(!t)return s;let r=localStorage.getItem("cache_"+e);if(!r)return s;try{r=JSON.parse(r)}catch(e){return s}return!r.timestamp||B.isExpired(r.timestamp,t)?s:r.data}static set(e,t){localStorage.setItem("cache_"+e,JSON.stringify({data:t,timestamp:v.now()}))}static remove(e){localStorage.removeItem("cache_"+e)}static keys(){return N.keys().filter((e=>e.startsWith("cache_"))).map((e=>e.substring(6)))}static clear(){const e=B.keys();for(const t of e)B.remove(t)}}class $ extends z{static cards(e,t){return $.getPage("/my/gamecards/"+e,t?{border:1}:{})}static stats(e,t){return $.getPage(`${e}/stats/${t}`)}static async getInventory(e){const t=N.get("login");if(!t)return console.warn("Must be signed in to access Inventory"),null;const s={l:"english",count:2e3};let r,a,n=null;do{const o=Object.assign(s,a?{start_assetid:a}:null);r=await $.getEndpoint(`/inventory/${t.steamId}/753/${e}`,o,(e=>{if(403===e.status)throw new i.LoginError("community")})),r&&r.success&&(n||(n={assets:[],descriptions:[]}),r.assets&&(n.assets=n.assets.concat(r.assets)),r.descriptions&&(n.descriptions=n.descriptions.concat(r.descriptions)),a=r.last_assetid)}while(r.more_items);if(!n)throw new Error("Could not retrieve Inventory 753/"+e);return n}static async coupons(){const e=new Map,t=await $.getInventory(3);if(!t)return null;for(const s of t.descriptions){if(!s.type||"Coupon"!==s.type)continue;if(!s.actions)continue;const t={image_url:s.icon_url,title:s.name,discount:s.name.match(/([1-9][0-9])%/)[1],id:`${s.classid}_${s.instanceid}`};s.descriptions.forEach(((e,s)=>{const r=e.value;r.startsWith("Can't be applied with other discounts.")?Object.assign(t,{discount_note:r,discount_note_id:s,discount_doesnt_stack:!0}):r.startsWith("(Valid")&&Object.assign(t,{valid_id:s,valid:r})}));for(const r of s.actions){const s=r.link.match(/[1-9][0-9]*(?:,[1-9][0-9]*)*/);if(s)for(let r of s[0].split(","))r=Number(r),(!e.has(r)||e.get(r).discount<t.discount)&&e.set(r,t);else console.warn("Couldn't find packageid(s) for link %s",r.link)}}const s=await q.get("packages",Array.from(e.keys()));for(const[t,r]of e.entries()){const e=s[t];r.appids=e||[]}return q.put("coupons",e)}static getCoupon(e){return q.getFromIndex("coupons","appid",e)}static hasCoupon(e){return q.indexContainsKey("coupons","appid",e)}static async giftsAndPasses(){const e=[],t=[];let s,r=await $.getInventory(1);if(!r)return null;function a(r,a){const n=W.getAppids(a.value);s=!0;for(const s of n)s&&("Gift"===r.type?e.push(s):t.push(s))}for(const n of r.descriptions){if(s=!1,n.descriptions)for(const e of n.descriptions)if("html"===e.type){a(e);break}if(!s&&n.actions){const s=W.getAppid(n.actions[0].link);s&&("Gift"===n.type?e.push(s):t.push(s))}}return r={gifts:e,passes:t},q.put("giftsAndPasses",r)}static hasGiftsAndPasses(e){return q.getFromIndex("giftsAndPasses","appid",e,{all:!0,asKey:!0})}static async items(){const e=await $.getInventory(6);return e?q.put("items",e.descriptions.map((e=>e.market_hash_name))):null}static hasItem(e){return q.contains("items",e)}static async fetchWorkshopFileSize({key:e}){const t=new DOMParser,s=await $.getPage("/sharedfiles/filedetails/",{id:e}),r=t.parseFromString(s,"text/html").querySelector(".detailsStatRight");if(!r||!r.innerText.includes("MB"))throw new Error("Couldn't find details block for workshop file size");const a=r.innerText.split(" ")[0].trim(),n=parseFloat(a.replace(/,/g,""));return q.put("workshopFileSizes",new Map([[Number(e),1e3*n]]))}static getWorkshopFileSize(e,t){return q.get("workshopFileSizes",Number(e),{preventFetch:t})}static _getReviewId(e){const t=e.querySelector("input");return Number(t?t.id.replace("ReviewVisibility",""):e.querySelector(".control_block > a").id.replace("RecommendationVoteUpBtn",""))}static async fetchReviews({key:e,params:{reviewCount:t}}){const s=new DOMParser,r=[];for(let a=1;a<=Math.ceil(t/10);a++){const t=s.parseFromString(await $.getPage(e+"/recommended",{p:a}),"text/html");for(const e of t.querySelectorAll(".review_box")){const t=e.querySelector(".header").innerHTML.split("<br>"),s=e.querySelector(".hours").textContent.split("(")[0].match(/(\d+,)?\d+\.\d+/),a=e.querySelector(".dselect_container:nth-child(2) .trigger"),n=$._getReviewId(e),o=e.querySelector("[src*=thumbsUp]")?1:0,i=t[0]&&t[0].match(/\d+/g)?parseInt(t[0].match(/\d+/g).join("")):0,c=t[1]&&t[1].match(/\d+/g)?parseInt(t[1].match(/\d+/g).join("")):0,l=e.querySelector(".content").textContent.trim().length,u=a?a.textContent:"Public",p=s?parseFloat(s[0].split(",").join("")):0;r.push({rating:o,helpful:i,funny:c,length:l,visibility:u,playtime:p,node:DOMPurify.sanitize(e.outerHTML),id:n})}}return q.put("reviews",{[e]:r})}static async updateReviewNode(e,t,s){const r=(new DOMParser).parseFromString(t,"text/html").querySelector(".review_box"),a=$._getReviewId(r);if(!await q.contains("reviews",e,{preventFetch:!0}))return null;const n=await q.get("reviews",e,{params:s});for(const e of n)if(e.id===a){e.node=DOMPurify.sanitize(r.outerHTML);break}return q.put("reviews",{[e]:n})}static getReviews(e,t){return q.get("reviews",e,{params:{reviewCount:t}})}static async login(e){const t=$;if(!e)throw t.logout(),new Error("Login endpoint needs a valid profile path");if(!e.startsWith("/id/")&&!e.startsWith("/profiles/"))throw t.logout(),new Error(`Could not interpret ${e} as a valid profile path`);const s=N.get("login");if(s&&s.profilePath===e)return s;const r=await t.getPage(e),a=l.getVariableFromText(r,"g_rgProfileData","object").steamid;if(!a)throw new Error("Failed to retrieve steamID from profile");t.logout(!0);const n={steamId:a,profilePath:e};return N.set("login",n),n}static logout(e=N.has("login")){e&&(N.remove("login"),N.remove("storeCountry"),B.remove("currency"))}static storeCountry(e){return e?(N.set("storeCountry",e),null):N.get("storeCountry")}static getProfile(e){return q.get("profiles",e,{params:{profile:e}})}static clearOwn(e){return q.delete("profiles",e)}static async getPage(e,t){const s=await this._fetchWithDefaults(e,t,{method:"GET"});if("/login/home/"===new URL(s.url).pathname)throw new i.LoginError("community");return s.text()}}$.origin="https://steamcommunity.com/",$.params={credentials:"include"};class U extends z{static async fetchPackage({key:e}){const t=await U.getEndpoint("/api/packagedetails/",{packageids:e}),s=new Map;for(const[e,r]of Object.entries(t))r&&r.success?s.set(Number(e),r.data.apps.map((e=>e.id))):s.set(Number(e),null);return q.put("packages",s)}static async wishlistAdd(e){let t;const s=await U.sessionId();if(s&&(t=await U.postEndpoint("/api/addtowishlist",{sessionid:s,appid:e})),!t||!t.success)throw new Error(`Failed to add app ${e} to wishlist`);return U.clearDynamicStore()}static async wishlistRemove(e,t){let s,r=t;if(r||(r=await U.sessionId()),r&&(s=await U.postEndpoint("/api/removefromwishlist",{sessionid:r,appid:e})),!s||!s.success)throw new Error(`Failed to remove app ${e} from wishlist`);return U.clearDynamicStore()}static async currencyFromWallet(){const e=await U.getPage("/steamaccount/addfunds");return l.htmlToDOM(e).querySelector("input[name=currency]").value}static async currencyFromApp(){const e=await U.getPage("/app/220"),t=l.htmlToDOM(e).querySelector("meta[itemprop=priceCurrency][content]");if(!t||!t.getAttribute("content"))throw new Error("Store currency could not be determined from app 220");return t.getAttribute("content")}static async currency(){let e=B.get("currency",3600);if(e)return e;if(e=await U.currencyFromWallet(),e||(e=await U.currencyFromApp()),!e)throw new Error("Could not retrieve store currency");return B.set("currency",e),e}static async country(){const e=U,t=await e.getPage("/account/change_country/",{},(e=>{if("/login/"===new URL(e.url).pathname)throw new i.LoginError("store")})),s=l.htmlToDOM(t).querySelector("#dselect_user_country");return s&&s.value}static async sessionId(){const e=U,t=await e.getPage("/news/");return l.getVariableFromText(t,"g_sessionID","string")}static async wishlists(e){const t=await U.getPage("/wishlist"+e),s=l.getVariableFromText(t,"g_rgWishlistData","array");return s?s.length:""}static async purchaseDate({params:e}){const t=[/- Complete Pack/gi,/Standard Edition/gi,/Steam Store and Retail Key/gi,/- Hardware Survey/gi,/ComputerGamesRO -/gi,/Founder Edition/gi,/Retail( Key)?/gi,/Complete$/gi,/Launch$/gi,/Free$/gi,/(RoW)/gi,/ROW/gi,/:/gi],s=new Map,r=await U.getPage("/account/licenses/",{l:e}),a=l.htmlToDOM(r).querySelectorAll("#main_content td.license_date_col");for(const e of a){const r=e.nextElementSibling,a=r.querySelector("div");a&&a.remove();let n=l.clearSpecialSymbols(r.textContent.trim());for(const e of t)n=n.replace(e,"");n=n.trim(),s.set(n,e.textContent)}return q.put("purchases",s)}static purchases(e,t){return q.get("purchases",e,{params:t})}static clearPurchases(){return q.clear("purchases")}static async dynamicStore(){const e=await U.getEndpoint("dynamicstore/userdata",{},null,{cache:"no-cache"}),{rgOwnedApps:t,rgOwnedPackages:s,rgIgnoredApps:r,rgWishlist:a}=e,n={ignored:Object.keys(r).map((e=>Number(e))),ownedApps:t,ownedPackages:s,wishlisted:a};return q.put("dynamicStore",n)}static dsStatus(e){return q.getFromIndex("dynamicStore","appid",e,{all:!0,asKey:!0})}static async dynamicStoreRandomApp(){const e=await q.getAll("dynamicStore");return e&&e.ownedApps?e.ownedApps[Math.floor(Math.random()*e.ownedApps.length)]:null}static async clearDynamicStore(){await q.clear("dynamicStore")}static appDetails(e,t){const s={appids:e};return t&&(s.filters=t),U.endpointFactory("api/appdetails/",e)(s)}static appUserDetails(e){return U.endpointFactory("api/appuserdetails/",e)({appids:e})}}U.origin="https://store.steampowered.com/",U.params={credentials:"include"},U._progressingRequests=new Map;class K{static async currencies(){const e=K;return(!e._supportedCurrencies||e._supportedCurrencies.length<1)&&(e._supportedCurrencies=await h.getJSON("json/currency.json")),e._supportedCurrencies}}K._supportedCurrencies=null;const G="https://api.isthereanydeal.com";class V extends z{static async authorize(){const e=crypto.getRandomValues(new Uint32Array(1))[0],t="https://isthereanydeal.com/connectaugmentedsteam",s=new URL(G+"/oauth/authorize/");s.searchParams.set("client_id","5fe78af07889f43a"),s.searchParams.set("response_type","token"),s.searchParams.set("state",e),s.searchParams.set("scope",V.requiredScopes.join(" ")),s.searchParams.set("redirect_uri",t);const r=await browser.tabs.create({url:s.toString()}),a=await new Promise(((e,s)=>{function a({url:t}){return e(t),browser.webRequest.onBeforeRequest.removeListener(a),browser.tabs.onRemoved.removeListener(n),browser.tabs.remove(r.id),{cancel:!0}}function n(e){e===r.id&&(s(new Error("Authorization tab closed")),browser.webRequest.onBeforeRequest.removeListener(a),browser.tabs.onRemoved.removeListener(n))}browser.webRequest.onBeforeRequest.addListener(a,{urls:[t,t+"#*"],tabId:r.id},["blocking"]),browser.tabs.onRemoved.addListener(n)})),n=new URL(a).hash,o=new URLSearchParams(n.substr(1));if(parseInt(o.get("state"))!==e)throw new Error("Failed to verify state parameter from URL fragment");const i=o.get("access_token"),c=o.get("expires_in");if(!i||!c)throw new Error(`Couldn't retrieve information from URL fragment "${n}"`);N.set("access_token",{token:i,expiry:v.now()+parseInt(c)})}static disconnect(){return N.remove("access_token"),N.remove("lastItadImport"),q.clear(["collection","waitlist","itadImport"])}static isConnected(){const e=N.get("access_token");return!!e&&(e.expiry<=v.now()?(N.remove("access_token"),!1):(V.accessToken=e.token,!0))}static endpointFactoryCached(e,t,s){return({params:r={},key:a}={})=>V.isConnected()?super.endpointFactoryCached(e,t,s)({params:Object.assign(r,{access_token:V.accessToken}),key:a}):null}static async addToWaitlist(e){if(!e||Array.isArray(e)&&!e.length)return console.warn("Can't add nothing to ITAD waitlist"),null;const t={version:"02",data:[]},s={};if(Array.isArray(e))e.forEach((e=>{const r="app/"+e;t.data.push({gameid:["steam",r]}),s[r]=null}));else{const r="app/"+e;t.data[0]={gameid:["steam",r]},s[r]=null}return await V.postEndpoint("v01/waitlist/import/",{access_token:V.accessToken},null,{body:JSON.stringify(t)}),q.put("waitlist",s)}static async removeFromWaitlist(e){if(!e||Array.isArray(e)&&!e.length)throw new Error("Can't remove nothing from ITAD Waitlist!");const t=(Array.isArray(e)?e:[e]).map((e=>"app/"+e));return await V.deleteEndpoint("v02/user/wait/remove/",{access_token:V.accessToken,shop:"steam",ids:t.join()}),q.delete("waitlist",t)}static addToCollection(e,t){if((!e||Array.isArray(e)&&!e.length)&&(!t||Array.isArray(t)&&!t.length))return console.warn("Can't add nothing to ITAD collection"),null;const s={version:"02",data:[]};let r,a;r=Array.isArray(e)?e:e?[e]:[],a=Array.isArray(t)?t:t?[t]:[];const n=r.map((e=>"app/"+e)).concat(a.map((e=>"sub/"+e)));for(const e of n)s.data.push({gameid:["steam",e],copies:[{type:"steam",status:"redeemed",owned:1}]});return V.postEndpoint("v01/collection/import/",{access_token:V.accessToken},null,{body:JSON.stringify(s)})}static async import(e){if(e)await q.clear("dynamicStore");else{const e=N.get("lastItadImport");if(e&&e.to&&!q.isExpired(e.to+43200))return}const s=[],r=[];t.get("itad_import_library")&&(s.push("ownedApps","ownedPackages"),r.push("lastOwnedApps","lastOwnedPackages")),t.get("itad_import_wishlist")&&(s.push("wishlisted"),r.push("lastWishlisted"));const a=await Promise.all([q.get("dynamicStore",s),q.get("itadImport",r)]);function n(e,t){return e?t?e.filter((e=>!t.includes(e))):e:[]}const o=[];if(t.get("itad_import_library")){const[{ownedApps:e,ownedPackages:t},{lastOwnedApps:s,lastOwnedPackages:r}]=a,i=n(e,s),c=n(t,r);(i.length||c.length)&&o.push(V.addToCollection(i,c).then((()=>q.put("itadImport",{lastOwnedApps:e,lastOwnedPackages:t}))))}if(t.get("itad_import_wishlist")){const[{wishlisted:e},{lastWishlisted:t}]=a,s=n(e,t);s.length&&o.push(V.addToWaitlist(s).then((()=>q.put("itadImport",{lastWishlisted:e}))))}await Promise.all(o);const i=N.get("lastItadImport")||{};i.to=v.now(),N.set("lastItadImport",i)}static async sync(){await Promise.all([V.import(!0),q.clear("waitlist").then((()=>q.objStoreFetchFns.get("waitlist")({params:{shop:"steam",optional:"gameid"}}))),q.clear("collection").then((()=>q.objStoreFetchFns.get("collection")({params:{shop:"steam",optional:"gameid,copy_type"}})))])}static lastImport(){return N.get("lastItadImport")}static mapCollection(e){if(!e)return null;const{games:t,typemap:s}=e,r={};t.forEach((({gameid:e,types:t})=>{const a=t.map((e=>s[e]));r[e]=a}));const a=N.get("lastItadImport")||{};return a.from=v.now(),N.set("lastItadImport",a),r}static mapWaitlist(e){if(!e)return null;const t=[];for(const{gameid:s}of Object.values(e))t.push(s);const s=N.get("lastItadImport")||{};return s.from=v.now(),N.set("lastItadImport",s),t}static inWaitlist(e){return q.contains("waitlist",e,{params:{shop:"steam",optional:"gameid"}})}static inCollection(e){return q.contains("collection",e,{params:{shop:"steam",optional:"gameid,copy_type"}})}static getFromCollection(e){return q.get("collection",e,{params:{shop:"steam",optional:"gameid,copy_type"}})}}V.accessToken=null,V.requiredScopes=["wait_read","wait_write","coll_read","coll_write"],V.origin=G,V._progressingRequests=new Map;class H extends z{static async getEndpoint(e,t){const s=await super.getEndpoint(e,t,(t=>{if(500===t.status)throw new i.ServerOutageError(`Augmented Steam servers are currently overloaded, failed to fetch endpoint "${e}"`)}));if(!s.result||"success"!==s.result)throw new Error(`Could not retrieve '${e}'`);return delete s.result,s}static storePageData(e,t,s){const r={appid:e};return t&&(r.mcurl=t),s&&(r.oc=1),q.get("storePageData",e,{params:r})}static expireStorePageData(e){return q.delete("storePageData","app_"+e)}static rates(e){return q.getAll("rates",{params:{to:e.sort().join(",")}})}static isEA(e){return q.contains("earlyAccessAppids",e)}static steamPeek(e){return H.endpointFactory("v01/similar")({appid:e,count:15})}}H.origin="https://esapi.isthereanydeal.com",H._progressingRequests=new Map;class J{static clearCache(){return B.clear(),q.clear()}static async moveNotesToSyncedStorage(){const e=Object.entries(await q.getAll("notes")),s=t.get("user_notes");for(const[t,r]of e)s[t]=r;t.set("user_notes",s)}static getNote(e){return q.get("notes",e)}static setNote(e,t){return q.put("notes",new Map([[e,t]]))}static deleteNote(e){return q.delete("notes",e)}static getAllNotes(){return q.getAll("notes")}static async setAllNotes(e){await J.clearNotes();const t=new Map(Object.entries(e).map((([e,t])=>[Number(e),t])));return q.put("notes",t)}static clearNotes(){return q.clear("notes")}}q.objStoreFetchFns=new Map([["coupons",$.coupons],["giftsAndPasses",$.giftsAndPasses],["items",$.items],["workshopFileSizes",$.fetchWorkshopFileSize],["reviews",$.fetchReviews],["purchases",U.purchaseDate],["dynamicStore",U.dynamicStore],["packages",U.fetchPackage],["earlyAccessAppids",H.endpointFactoryCached("v01/earlyaccess","earlyAccessAppids")],["storePageData",H.endpointFactoryCached("v01/storepagedata","storePageData")],["profiles",H.endpointFactoryCached("v01/profile/profile","profiles")],["rates",H.endpointFactoryCached("v01/rates","rates")],["collection",V.endpointFactoryCached("v02/user/coll/all","collection",V.mapCollection)],["waitlist",V.endpointFactoryCached("v01/user/wait/all","waitlist",V.mapWaitlist)]]);const Q=new Map([["wishlist.add",U.wishlistAdd],["wishlist.remove",U.wishlistRemove],["dynamicstore.clear",U.clearDynamicStore],["steam.currencies",K.currencies],["migrate.notesToSyncedStorage",J.moveNotesToSyncedStorage],["notes.get",J.getNote],["notes.set",J.setNote],["notes.delete",J.deleteNote],["notes.getall",J.getAllNotes],["notes.setall",J.setAllNotes],["notes.clear",J.clearNotes],["cache.clear",J.clearCache],["dlcinfo",H.endpointFactory("v01/dlcinfo")],["storepagedata",H.storePageData],["storepagedata.expire",H.expireStorePageData],["prices",H.endpointFactory("v01/prices")],["rates",H.rates],["isea",H.isEA],["profile.background",H.endpointFactory("v01/profile/background/background")],["profile.background.games",H.endpointFactory("v01/profile/background/games")],["twitch.stream",H.endpointFactory("v01/twitch/stream")],["market.cardprices",H.endpointFactory("v01/market/cardprices")],["market.averagecardprice",H.endpointFactory("v01/market/averagecardprice")],["market.averagecardprices",H.endpointFactory("v01/market/averagecardprices")],["steampeek",H.steamPeek],["appdetails",U.appDetails],["appuserdetails",U.appUserDetails],["currency",U.currency],["sessionid",U.sessionId],["wishlists",U.wishlists],["purchases",U.purchases],["clearpurchases",U.clearPurchases],["dynamicstorestatus",U.dsStatus],["dynamicStore.randomApp",U.dynamicStoreRandomApp],["login",$.login],["logout",$.logout],["storecountry",$.storeCountry],["cards",$.cards],["stats",$.stats],["coupon",$.getCoupon],["hasgiftsandpasses",$.hasGiftsAndPasses],["hascoupon",$.hasCoupon],["hasitem",$.hasItem],["profile",$.getProfile],["clearownprofile",$.clearOwn],["workshopfilesize",$.getWorkshopFileSize],["reviews",$.getReviews],["updatereviewnode",$.updateReviewNode],["itad.authorize",V.authorize],["itad.disconnect",V.disconnect],["itad.isconnected",V.isConnected],["itad.import",V.import],["itad.sync",V.sync],["itad.lastimport",V.lastImport],["itad.inwaitlist",V.inWaitlist],["itad.addtowaitlist",V.addToWaitlist],["itad.removefromwaitlist",V.removeFromWaitlist],["itad.incollection",V.inCollection],["itad.getfromcollection",V.getFromCollection],["error.test",()=>Promise.reject(new Error("This is a TEST Error. Please ignore."))]]);browser.runtime.onMessage.addListener((async(e,r)=>{if(!r||!r.tab)return null;if(!e||!e.action)return null;const a=Q.get(e.action);if(!a)throw new Error(`Did not recognize "${e.action}" as an action.`);let n;e.params=e.params||[];try{await Promise.all([q,t.then((()=>{!function(){if(s)return;s=!0;const e={ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|chrome-extension|moz-extension|steam):|[^a-z]|[a-z+.-]+(?:[^a-z+.\-:]|$))/i};t.get("openinnewtab")&&(e.ADD_ATTR=["target"],DOMPurify.addHook("uponSanitizeAttribute",((e,t)=>{"target"===t.attrName&&("_blank"===t.attrValue?e.setAttribute("rel","noreferrer noopener"):t.keepAttr=!1)}))),DOMPurify.setConfig(e)}()}))]),n=await a(...e.params)}catch(t){throw console.group(`Callback: "${e.action}"`),console.error('Failed to execute callback "%s" with params %o',e.action,e.params),console.error(t),console.groupEnd(),new Error(t.toString())}return n})),browser.runtime.onStartup.addListener(y.update),browser.runtime.onInstalled.addListener(y.update),f.when("contextMenus",(()=>{browser.contextMenus.onClicked.addListener(y.onClick)}),(()=>{browser.contextMenus.onClicked.removeListener(y.onClick)}))})();
//# sourceMappingURL=background.js.map